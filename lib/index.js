"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),React__default=_interopDefault(React),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function __rest(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(r[i[n]]=e[i[n]])}return r}function __spreadArrays(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),n=0;for(t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,n++)i[n]=o[s];return i}!function(e){e[e.All=0]="All",e[e.Init=1]="Init",e[e.Update=2]="Update",e[e.DumpUpdate=3]="DumpUpdate"}(exports.StoreEventType||(exports.StoreEventType={}));var StoreEvent=function(){function e(e,t,r,i){this.id=e,this.types=t,this.onFire=r,this.onRemove=i,this.timeout=null}return e.prototype.remove=function(){this.timeout&&clearTimeout(this.timeout),this.onRemove(this.id)},e}(),StoreEventSpecificKeys=function(){function e(e,t,r,i,n){void 0===n&&(n=[]),this.id=e,this.types=t,this.onFire=r,this.onRemove=i,this.includeKeys=n,this.timeout=null}return e.prototype.remove=function(){this.timeout&&clearTimeout(this.timeout),this.onRemove(this.id)},e}(),followStore=function(e){return function(t){return function(r){function i(){var e=null!==r&&r.apply(this,arguments)||this;return e.storeEvent=null,e.state={storeState:null},e}return __extends(i,r),i.prototype.componentWillMount=function(){var t=this;this.storeEvent=e.on(exports.StoreEventType.All,(function(){t.forceUpdate()}))},i.prototype.componentWillUnmount=function(){this.storeEvent.remove()},i.prototype.render=function(){return React.createElement(t,this.props)},i}(React.Component)}},StorePersistentDriver=function(){function e(e,t){void 0===t&&(t=1/0),this.name=e,this.lifetime=t,this.persistence=!0,this.initialState=null}return e.prototype.pack=function(e){return{data:e,timestamp:Date.now()}},e.prototype.reset=function(){var e=this.pack(this.initialState);return this.write(e),e},Object.defineProperty(e.prototype,"storeName",{get:function(){return("store.persistent."+this.type+"."+this.name).toLowerCase()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dumpHistoryName",{get:function(){return("store.persistent.dump.history."+this.type+"."+this.name).toLowerCase()},enumerable:!0,configurable:!0}),e}(),StorePersistentLocalStorageDriver=function(e){function t(t,r){void 0===r&&(r=1/0);var i=e.call(this,t,r)||this;return i.name=t,i.lifetime=r,i.storage=null,i.type="localStorage","undefined"!=typeof window&&window.localStorage&&(i.storage=window.localStorage),i}return __extends(t,e),t.prototype.write=function(e){if(this.storage&&this.persistence)try{this.storage.setItem(this.storeName,JSON.stringify(e))}catch(e){console.error(e)}},t.prototype.read=function(){if(this.storage&&this.persistence){var e=null;try{e=JSON.parse(this.storage.getItem(this.storeName)),Boolean(e)||Boolean(e.timestamp)||(e=this.reset())}catch(t){e=this.reset()}return e}return this.reset()},t.prototype.saveDump=function(e){var t=e.timestamp;if(this.storage&&this.persistence)try{var r=JSON.parse(this.storage.getItem(this.dumpHistoryName));r&&r.dumpHistory?(r.dumpHistory.push(e),this.storage.setItem(this.dumpHistoryName,JSON.stringify(r))):this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[e]}))}catch(r){try{this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[e]}))}catch(e){console.error(e),t=null}console.error(r),t=null}return t},t.prototype.removeDump=function(e){if(this.storage&&this.persistence)try{var t=JSON.parse(this.storage.getItem(this.dumpHistoryName));if(t&&t.dumpHistory){var r=t.dumpHistory.filter((function(t){return t.timestamp!==e}));this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:r}))}}catch(e){console.error(e)}},t.prototype.readDump=function(e){var t=null;if(this.storage&&this.persistence)try{var r=JSON.parse(this.storage.getItem(this.dumpHistoryName));t=r&&r.dumpHistory?r.dumpHistory.find((function(t){return t.timestamp===e})):null}catch(e){console.error(e)}return t},t.prototype.getDumpHistory=function(){var e=[];if(this.storage&&this.persistence)try{var t=JSON.parse(this.storage.getItem(this.dumpHistoryName));t&&t.dumpHistory&&(e=t.dumpHistory.map((function(e){return e.timestamp})))}catch(t){console.error(t),e=[]}return e},t.prototype.resetHistory=function(){if(this.storage&&this.persistence)try{this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[]}))}catch(e){console.error(e)}},t.prototype.clear=function(){if(this.storage&&this.persistence)try{this.storage.removeItem(this.storeName)}catch(e){console.error(e)}},t}(StorePersistentDriver);function isPrimitive(e){switch(typeof e){case"undefined":case"boolean":case"number":case"string":case"symbol":return!0;default:return!1}}function areSimilar(e,t){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(e===t)return!0;if(isPrimitive(e)||isPrimitive(t))return e===t;if(null===e||null===t)return!1;if(Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return!1;for(var n=new Set(r),o=new Set(Object.keys(e)),s=new Set(Object.keys(t)),a=0,u=r;a<u.length;a++){var p=u[a];o.add(p),s.add(p)}if(o.size!==s.size)return!1;var c=Array.from(o),h=Array.from(s);c.sort(),h.sort();for(var f=c.length-1;f>=0;f--)if(c[f]!==h[f])return!1;for(f=c.length-1;f>=0;f--){p=c[f];if(!n.has(p)&&!areSimilar.apply(void 0,__spreadArrays([e[p],t[p]],r)))return!1}return typeof e==typeof t}var StoreEventManager=function(){function e(e,t){this.fireTimeout=e,this.name=t,this.events=[],this.eventCounter=0,this.timeout=null,this._hook=null,this._hook="undefined"!=typeof window&&window.__REACT_STORES_INSPECTOR__}return e.prototype.getEventsCount=function(){return this.events.length},e.prototype.generateEventId=function(){return""+ ++this.eventCounter+Date.now()+Math.random()},e.prototype.fire=function(e,t,r,i){var n=this;if(i)this.fireTimeout&&0!==this.fireTimeout?(i.timeout&&clearTimeout(this.timeout),i.timeout=setTimeout((function(){n.doFire(e,t,r,i)}),this.fireTimeout)):this.doFire(e,t,r,i);else if(this.fireTimeout&&0!==this.fireTimeout)this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((function(){for(var i in n.events)n.events.hasOwnProperty(i)&&n.doFire(e,t,r,n.events[i])}),this.fireTimeout);else for(var o in this.events)this.events.hasOwnProperty(o)&&this.doFire(e,t,r,this.events[o])},e.prototype.remove=function(e){if(this.fireTimeout&&0!==this.fireTimeout)for(var t in this.events)this.events.hasOwnProperty(t)&&this.events[t].timeout&&clearTimeout(this.timeout);this.events=this.events.filter((function(t){return t.id!==e})),this._hook&&this._hook.removeEvent(this.name,e)},e.prototype.add=function(e,t,r){var i,n=this;return i=r?new StoreEventSpecificKeys(this.generateEventId(),e,t,(function(e){n.remove(e)}),r):new StoreEvent(this.generateEventId(),e,t,(function(e){n.remove(e)})),this.events.push(i),this._hook&&this._hook.addEvent(this.name,i.id),i},e.prototype.doFire=function(e,t,r,i){if(i.types.includes(e)||i.types.includes(exports.StoreEventType.All)){if(i instanceof StoreEventSpecificKeys){var n=Object.keys(t).filter((function(e){return!i.includeKeys.includes(e)}));return void(areSimilar.apply(void 0,__spreadArrays([t,r],n))||i.onFire(t,r,i.includeKeys,e))}i.onFire(t,r,e)}},e}(),Store=function(){function e(e,t,r){var i,n;this.persistenceDriver=r,this.version="5.0.3",this.eventManager=null,this.initialState=null,this.frozenState=null,this._hook=null,this.opts={name:"",live:!1,freezeInstances:!1,immutable:!1,persistence:!1,setStateTimeout:0},this._hook="undefined"!=typeof window&&window.__REACT_STORES_INSPECTOR__;var o=null;if(this.name=null!=(n=null===(i=t)||void 0===i?void 0:i.name)?n:this.generateStoreId(e),t&&(this.opts.name=this.name,this.opts.immutable=!0===t.immutable,this.opts.persistence=!0===t.persistence,this.opts.setStateTimeout=t.setStateTimeout),this.persistenceDriver||(this.persistenceDriver=new StorePersistentLocalStorageDriver(this.name+this.generateStoreId(e))),this.opts.persistence){var s=this.persistenceDriver.read().data;s&&(o=s)}null===o&&(o=e),this.persistenceDriver.persistence=this.opts.persistence,this.persistenceDriver.initialState=e,this.eventManager=new StoreEventManager(this.opts.setStateTimeout,this.name),this.initialState=this.deepFreeze(e),this.frozenState=this.deepFreeze(o),this._hook&&this._hook.attachStore(this,this.name,this.opts,!1)}return Object.defineProperty(e.prototype,"state",{get:function(){return this.frozenState},enumerable:!0,configurable:!0}),e.prototype.deepFreeze=function(e){if(this.opts.immutable){var t=Object.getOwnPropertyNames(e);for(var r in t)if(t.hasOwnProperty(r)){var i=e[t[r]];"object"==typeof i&&null!==i&&this.deepFreeze(i)}return Object.freeze(e)}return e},e.prototype.hashCode=function(e){for(var t=0,r=0;r<e.length;r++)t=Math.imul(31,t)+e.charCodeAt(r)|0;return t.toString(16)},e.prototype.generateStoreId=function(e){var t="";for(var r in e)e.hasOwnProperty(r)&&(t+=r);return this.hashCode(t)},e.prototype.resetPersistence=function(){this.persistenceDriver.reset()},e.prototype.clearPersistence=function(){this.persistenceDriver.clear()},e.prototype.resetDumpHistory=function(){this.persistenceDriver.resetHistory(),this.eventManager.fire(exports.StoreEventType.DumpUpdate,this.frozenState,this.frozenState)},e.prototype.saveDump=function(){var e=this.persistenceDriver.saveDump(this.persistenceDriver.pack(this.frozenState));return this.eventManager.fire(exports.StoreEventType.DumpUpdate,this.frozenState,this.frozenState),e},e.prototype.removeDump=function(e){this.persistenceDriver.removeDump(e),this.eventManager.fire(exports.StoreEventType.DumpUpdate,this.frozenState,this.frozenState)},e.prototype.restoreDump=function(e){var t=this.persistenceDriver.readDump(e);if(t){var r=this.deepFreeze(this.frozenState);this.setState(__assign(__assign({},t.data),{$actionName:"@restoreDump"})),this.eventManager.fire(exports.StoreEventType.DumpUpdate,this.frozenState,r)}},e.prototype.getDumpHistory=function(){return this.persistenceDriver.getDumpHistory()},e.prototype.setState=function(e){var t=e.$actionName,r=__rest(e,["$actionName"]),i=this.deepFreeze(this.frozenState),n=this.deepFreeze(__assign(__assign({},i),r));this.frozenState=n,this.persistenceDriver.write(this.persistenceDriver.pack(n)),this.eventManager.fire(exports.StoreEventType.Update,n,i),this._hook&&this._hook.updateState(this.name,r,t)},e.prototype.resetState=function(){this.setState(__assign(__assign({},this.deepFreeze(this.initialState)),{$actionName:"@resetState"}))},e.prototype.removeStore=function(){this._hook&&this._hook.removeStore(this.name)},e.prototype.getInitialState=function(){return this.initialState},e.prototype.on=function(e,t,r){var i,n=e&&e.constructor===Array?e:[e];return i=Array.isArray(t)?this.eventManager.add(n,r,t):this.eventManager.add(n,t),this.eventManager.fire(exports.StoreEventType.Init,this.frozenState,this.frozenState,i),this.eventManager.fire(exports.StoreEventType.DumpUpdate,this.frozenState,this.frozenState,i),i},e}();function getOption(e){var t=function(e){return e},r=function(e,t){return e===t},i=exports.StoreEventType.All,n=[];return e[0]&&(Object.keys(exports.StoreEventType).includes(e[0].toString())||Array.isArray(e[0])&&Object.keys(exports.StoreEventType).includes(e[0][0].toString()))?{eventType:e[0],mapState:e[1]||t,compare:e[2]||r,includeKeys:n}:e[0]&&Array.isArray(e[0])&&"string"==typeof e[0][0]?{eventType:e[1]||i,mapState:t,compare:r,includeKeys:e[0]}:"function"==typeof e[0]?{eventType:i,mapState:e[0]||t,compare:e[1]||r,includeKeys:n}:e[0]?{eventType:e[0].eventType||i,mapState:e[0].mapState||t,compare:e[0].compare||r,includeKeys:n}:{mapState:t,compare:r,eventType:i,includeKeys:n}}function useStore(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var i=React.useMemo((function(){return getOption(t)}),[]),n=React.useRef(e),o=React.useMemo((function(){return i.mapState(n.current.state)}),[]),s=React.useState(0),a=React.useRef(o);return React.useEffect((function(){var e;return e=i.includeKeys.length>0?n.current.on(i.eventType,i.includeKeys,(function(e){a.current=i.mapState(e),s[1](Date.now())})):n.current.on(i.eventType,(function(e,t,r){var n=i.mapState(e,t,r);i.compare&&i.compare(n,a.current)||(a.current=n,s[1](Date.now()))})),function(){e.remove()}}),[]),a.current}function useIsolatedStore(e,t,r){var i=React__default.useState(0),n=React__default.useRef(React__default.useMemo((function(){return new Store(e,__assign({persistence:!1,immutable:!0},t),r)}),[]));return React__default.useEffect((function(){var e=n.current.on(exports.StoreEventType.Update,(function(){i[1](Date.now())}));return function(){var r;e.remove(),(null===(r=t)||void 0===r?void 0:r.persistence)||n.current.resetState(),n.current.removeStore()}}),[]),n.current}exports.Store=Store,exports.StoreEvent=StoreEvent,exports.StorePersistentDriver=StorePersistentDriver,exports.StorePersistentLocalStorageDriver=StorePersistentLocalStorageDriver,exports.areSimilar=areSimilar,exports.followStore=followStore,exports.useIsolatedStore=useIsolatedStore,exports.useStore=useStore;
